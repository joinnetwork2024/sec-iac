name: Security IaC CI

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

permissions:
  contents: read
  id-token: write

############################################
# JOB 1: Terraform IaC Security (AWS + Azure)
############################################
jobs:
  terraform-security-check:
    runs-on: ubuntu-latest
    environment: region

    strategy:
      matrix:
        cloud: [aws, azure]
      fail-fast: false

    defaults:
      run:
        working-directory: environments/dev/${{ matrix.cloud }}

    env:
      TF_VAR_region: ${{ vars.REGION }}
      TF_VAR_location: ${{ vars.LOCATION }}
      TF_VAR_project_name: ${{ vars.PROJECT_NAME }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Install Conftest
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/download/v0.53.0/conftest_0.53.0_Linux_x86_64.tar.gz | tar -xz
          sudo mv conftest /usr/local/bin/conftest

      - name: Terraform fmt check
        run: terraform fmt -check

      - name: Terraform init
        run: terraform init

      - name: Terraform validate
        run: terraform validate

      ############################################
      # AWS Authentication
      ############################################
      - name: Configure AWS Credentials
        if: matrix.cloud == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-west-2
          role-session-name: github-sec-iac

      - name: Test AWS identity
        if: matrix.cloud == 'aws'
        run: aws sts get-caller-identity

      ############################################
      # Azure Authentication
      ############################################
      - name: Configure Azure Credentials
        if: matrix.cloud == 'azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      ############################################
      # Terraform Plan + Policy Enforcement
      ############################################
      - name: Terraform plan
        run: terraform plan -out=plan.tfplan

      - name: Convert plan to JSON
        run: terraform show -json plan.tfplan > plan.json

      - name: Run Conftest IaC Policies
        run: |
          conftest test plan.json \
            --policy $GITHUB_WORKSPACE/policies/rego \
            --all-namespaces \
            --fail-on-warn

      - name: Upload Terraform plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan-${{ matrix.cloud }}
          path: environments/dev/${{ matrix.cloud }}/plan.json

############################################
# JOB 2: AI Model Container Supply Chain Security
############################################
  ai-image-security:
    runs-on: ubuntu-latest
    needs: terraform-security-check

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Conftest
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/download/v0.53.0/conftest_0.53.0_Linux_x86_64.tar.gz | tar -xz
          sudo mv conftest /usr/local/bin/conftest

      ############################################
      # Vulnerability Scan (Trivy via Docker)
      ############################################
      - name: Scan image with Trivy (remote)
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v ${{ github.workspace }}:/work \
            aquasec/trivy:latest \
            image \
            --format json \
            --output /work/trivy.json \
            public.ecr.aws/my-org/ai-model:latest

      ############################################
      # Normalize CVE Data for OPA
      ############################################
      - name: Normalize vulnerability data
        run: |
          jq '{
            vulnerabilities: {
              critical: ([.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length),
              high: ([.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length)
            }
          }' trivy.json > opa-input.json

      ############################################
      # OPA / Rego Policy Enforcement
      ############################################
      - name: Run AI image security policies
        run: |
          conftest test opa-input.json \
            --policy policies/rego \
            --namespace sec_iac.ai_ml.security \
            --fail-on-warn
