name: Security IaC CI


on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

jobs:
  terraform-security-check:
    runs-on: ubuntu-latest
    environment: region   # Gives access to your vars: REGION, LOCATION, PROJECT_NAME
    permissions:
      id-token: write      # ← REQUIRED for OIDC token request
      contents: read       # Good practice for checkout
    strategy:
      matrix:
        cloud: [aws, azure]
      fail-fast: false

    defaults:
      run:
        working-directory: environments/dev/${{ matrix.cloud }}

    env:
      # These are available globally because of 'environment: region'
      TF_VAR_region: ${{ vars.REGION }}
      TF_VAR_location: ${{ vars.LOCATION }}
      TF_VAR_project_name: ${{ vars.PROJECT_NAME }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Install Conftest
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/download/v0.53.0/conftest_0.53.0_Linux_x86_64.tar.gz | tar -xz
          sudo mv conftest /usr/local/bin/conftest

      - name: Terraform fmt check
        run: terraform fmt -check
        working-directory: environments/dev/${{ matrix.cloud }}

      - name: Terraform init
        run: terraform init 
        working-directory: environments/dev/${{ matrix.cloud }}

      - name: Terraform validate
        run: terraform validate
        working-directory: environments/dev/${{ matrix.cloud }}

      - name: Configure AWS Credentials (AWS only)
        if: matrix.cloud == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}   # Secret → use secrets.
          aws-region: eu-west-2
          role-session-name: github-sec-iac
        env:
          ACTIONS_STEP_DEBUG: true
          
      - name: Test AWS identity
        if: matrix.cloud == 'aws'
        run: aws sts get-caller-identity

      - name: Terraform plan
        run: terraform plan -out=plan.tfplan
        working-directory: environments/dev/${{ matrix.cloud }}

      - name: Convert plan to JSON
        run: terraform show -json plan.tfplan > plan.json
        working-directory: environments/dev/${{ matrix.cloud }}

      - name: Run Conftest Policy Check (${{ matrix.cloud }})
        run: conftest test plan.json --policy ../../../../policies/rego --fail-on-warn
        working-directory: environments/dev/${{ matrix.cloud }}

      - name: Upload plan artifact (${{ matrix.cloud }})
        uses: actions/upload-artifact@v4
        with:
          name: plan-${{ matrix.cloud }}
          path: environments/dev/${{ matrix.cloud }}/plan.json